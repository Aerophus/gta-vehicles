<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>GTA V Vehicle Viewer</title>
		<style>
			/* Reset & base */
			* {
				box-sizing: border-box;
				margin: 0;
				padding: 0;
			}
			body {
				font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
				display: flex;
				height: 100vh;
				background: #121212;
				color: #fff;
			}

			/* Sidebar */
			#sidebar {
				width: 280px;
				background: #1e1e1e;
				border-right: 1px solid #333;
				padding: 20px;
				overflow-y: auto;
				display: flex;
				flex-direction: column;
				gap: 10px;
				transition: transform 0.3s ease;
			}
			#sidebar input {
				width: 100%;
				padding: 10px 12px;
				border: none;
				border-radius: 8px;
				background: #2a2a2a;
				color: #fff;
				font-size: 14px;
				transition: background 0.2s;
			}
			#sidebar input:focus {
				outline: none;
				background: #3a3a3a;
			}
			#vehicleList {
				list-style: none;
				padding: 0;
				margin-top: 10px;
				display: flex;
				flex-direction: column;
				gap: 2px;
			}
			#vehicleList li {
				padding: 9px 15px;
				border-radius: 4px;
				cursor: pointer;
				border-left: 4px solid transparent;
				transition: all 0.2s ease;
				color: #a0a0a0;
			}
			#vehicleList li:hover {
				background: #2c2c2c;
				border-left-color: #444;
				color: #fff;
			}
			#vehicleList li.selected {
				background: #3a3a3a;
				border-left-color: #007bff;
				color: #fff;
				font-weight: 500;
			}

			/* Viewer */
			#viewer {
				flex: 1;
				display: flex;
				justify-content: center;
				align-items: center;
				background: #111;
				padding: 0;
			}

			/* Canvas wrapper: maintain 16:9 ratio */
			#canvasWrapper {
				position: relative;
				width: 100%;
				max-width: 95%; /* limit width so it doesnâ€™t stretch too much */
				aspect-ratio: 16 / 9;
				border-radius: 16px;
				overflow: hidden;
			}

			/* Canvas styling */
			#canvasWrapper canvas {
				width: 100%;
				height: 100%;
				border-radius: 16px;
				cursor: ew-resize;
				background: #111;
			}

			/* Custom scrollbar */
			#sidebar::-webkit-scrollbar {
				width: 8px;
			}
			#sidebar::-webkit-scrollbar-thumb {
				background-color: #555;
				border-radius: 4px;
			}
			#sidebar::-webkit-scrollbar-track {
				background-color: #1e1e1e;
			}

			/* Mobile Styles */
			@media (max-width: 768px) {
				body {
					position: relative;
				}
				#sidebar {
					position: absolute;
					top: 0;
					left: 0;
					width: 100%;
					height: auto;
					z-index: 10;
					border-right: none;
					background: transparent;
					padding: 15px;
					gap: 0;
					overflow-y: visible; /* Prevent clipping of the absolute positioned list */
				}
				#sidebar input {
					box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
				}
				#vehicleList {
					position: absolute;
					top: 65px; /* Position below search */
					left: 15px;
					right: 15px;
					background: #1e1e1e;
					border-radius: 8px;
					box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
					max-height: calc(100vh - 80px);
					overflow-y: auto;

					/* Visibility handled by class */
					opacity: 0;
					visibility: hidden;
					transform: translateY(-10px);
					transition: opacity 0.2s, transform 0.2s, visibility 0.2s;
				}
				#vehicleList.visible {
					opacity: 1;
					visibility: visible;
					transform: translateY(0);
				}
				#viewer {
					padding: 0;
					width: 100%;
					position: absolute;
					top: 0;
					left: 0;
					height: 100vh;
					z-index: 1;
				}
				#canvasWrapper {
					border-radius: 0;
					width: 100%;
					height: 100%;
					max-width: none;
					aspect-ratio: unset;
				}
			}
		</style>
	</head>
	<body>
		<div id="sidebar">
			<input type="text" id="search" placeholder="Search vehicles..." />
			<ul id="vehicleList"></ul>
		</div>

		<div id="viewer">
			<div id="canvasWrapper">
				<canvas id="viewerCanvas"></canvas>
			</div>
		</div>

		<script>
			const imagesFolder = "images";
			const vehicleList = document.getElementById("vehicleList");
			const searchInput = document.getElementById("search");
			const canvas = document.getElementById("viewerCanvas");
			const ctx = canvas.getContext("2d");
			const IMAGE_CACHE_LIMIT = 10;
			const imageCache = new Map();

			let dayImage;
			let nightImage;
			let sliderX = 0; // initial slider position
			let canvasWidth, canvasHeight;
			let selectedVehicleName = null; // Track selected vehicle

			const isMobile = () => window.innerWidth <= 768;

			// Load vehicles.json dynamically
			fetch("vehicles.json")
				.then((res) => res.json())
				.then((data) => {
					window.vehicles = data;
					renderList();
					if (window.vehicles.length > 0) {
						selectVehicle(window.vehicles[0]); // now passes the object, not the string
					}
				});

			// Render vehicle list
			function renderList(filter = "") {
				vehicleList.innerHTML = "";
				const filtered = window.vehicles.filter((v) =>
					v.name.toLowerCase().includes(filter.toLowerCase())
				);

				if (filtered.length === 0 && filter) {
					const li = document.createElement("li");
					li.textContent = "No results found";
					li.style.cursor = "default";
					li.style.color = "#666";
					vehicleList.appendChild(li);
				} else {
					filtered.forEach((v) => {
						const li = document.createElement("li");
						li.textContent = v.name; // display the name
						if (v.name === selectedVehicleName) {
							li.classList.add("selected");
						}
						li.addEventListener("click", () => selectVehicle(v));
						vehicleList.appendChild(li);
					});
				}
			}

			// Filter list
			searchInput.addEventListener("input", () => {
				const filter = searchInput.value;
				renderList(filter);
				if (isMobile()) {
					if (filter) {
						vehicleList.classList.add("visible");
					} else {
						vehicleList.classList.remove("visible");
					}
				}
			});

			function loadCachedImage(src) {
				// If cached, refresh its position (LRU behavior)
				if (imageCache.has(src)) {
					const img = imageCache.get(src);
					imageCache.delete(src);
					imageCache.set(src, img);
					return Promise.resolve(img);
				}

				return new Promise((resolve, reject) => {
					const img = new Image();
					img.onload = () => {
						imageCache.set(src, img);

						// Evict oldest entry if cache is too big
						if (imageCache.size > IMAGE_CACHE_LIMIT) {
							const oldestKey = imageCache.keys().next().value;
							imageCache.delete(oldestKey);
						}

						resolve(img);
					};
					img.onerror = reject;
					img.src = src;
				});
			}

			// Set images on selection
			let loadToken = 0;

			function selectVehicle(vehicle) {
				if (selectedVehicleName === vehicle.name) {
					if (isMobile()) vehicleList.classList.remove("visible");
					return;
				}

				selectedVehicleName = vehicle.name;
				// Update selected class
				for (const li of vehicleList.children) {
					li.classList.toggle("selected", li.textContent === vehicle.name);
				}

				const currentToken = ++loadToken;

				// Use the new dayImage and nightImage fields
				const daySrc = `${imagesFolder}/${vehicle.dayImage}`;
				const nightSrc = `${imagesFolder}/${vehicle.nightImage}`;

				Promise.all([loadCachedImage(daySrc), loadCachedImage(nightSrc)]).then(
					([dayImg, nightImg]) => {
						if (currentToken !== loadToken) return;
						dayImage = dayImg;
						nightImage = nightImg;
						drawCanvas();
					}
				);

				if (isMobile()) {
					vehicleList.classList.remove("visible");
					searchInput.blur();
				}
			}

			// Update canvas size with device pixel ratio
			function resizeCanvas() {
				const dpr = window.devicePixelRatio || 1;

				const wrapper = document.getElementById("canvasWrapper");
				canvasWidth = wrapper.clientWidth * dpr;
				canvasHeight = wrapper.clientHeight * dpr;

				canvas.width = canvasWidth;
				canvas.height = canvasHeight;

				ctx.setTransform(1, 0, 0, 1, 0, 0);
				ctx.scale(dpr, dpr);

				sliderX = wrapper.clientWidth / 2; // slider in CSS pixels
				drawCanvas();
			}

			window.addEventListener("resize", resizeCanvas);
			resizeCanvas();

			// Draw canvas: split night/day based on slider
			function drawCanvas() {
				ctx.clearRect(0, 0, canvas.width, canvas.height);
				//ctx.imageSmoothingEnabled = false;

				const cw = canvas.clientWidth;
				const ch = canvas.clientHeight;

				// Night on left
				if (nightImage && nightImage.complete) {
					ctx.save();
					ctx.beginPath();
					ctx.rect(0, 0, sliderX, ch);
					ctx.clip();
					drawImageContain(nightImage, cw, ch);
					ctx.restore();
				}

				// Day on right
				if (dayImage && dayImage.complete) {
					ctx.save();
					ctx.beginPath();
					ctx.rect(sliderX, 0, cw - sliderX, ch);
					ctx.clip();
					drawImageContain(dayImage, cw, ch);
					ctx.restore();
				}

				// Slider line
				ctx.fillStyle = "white";
				ctx.fillRect(sliderX - 1.5, 0, 3, ch);
			}

			// Draw image with 'contain' behavior
			function drawImageContain(img, cw, ch) {
				const imgRatio = img.width / img.height;
				const canvasRatio = cw / ch;

				let drawWidth, drawHeight, offsetX, offsetY;

				if (imgRatio > canvasRatio) {
					drawWidth = cw;
					drawHeight = cw / imgRatio;
					offsetX = 0;
					offsetY = (ch - drawHeight) / 2;
				} else {
					drawHeight = ch;
					drawWidth = ch * imgRatio;
					offsetX = (cw - drawWidth) / 2;
					offsetY = 0;
				}

				ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
			}

			// Draggable slider - Mouse events
			let isDragging = false;

			canvas.addEventListener("mousedown", () => {
				isDragging = true;
			});
			document.addEventListener("mouseup", () => {
				isDragging = false;
			});
			document.addEventListener("mousemove", (e) => {
				if (!isDragging) return;
				const rect = canvas.getBoundingClientRect();
				sliderX = e.clientX - rect.left;
				sliderX = Math.max(0, Math.min(canvas.clientWidth, sliderX));
				drawCanvas();
			});

			// Draggable slider - Touch events
			canvas.addEventListener(
				"touchstart",
				(e) => {
					e.preventDefault();
					isDragging = true;
				},
				{ passive: false }
			);

			document.addEventListener("touchend", (e) => {
				isDragging = false;
			});

			canvas.addEventListener(
				"touchmove",
				(e) => {
					if (!isDragging) return;
					e.preventDefault();
					const rect = canvas.getBoundingClientRect();
					const touchX = e.touches[0].clientX;
					sliderX = touchX - rect.left;
					sliderX = Math.max(0, Math.min(canvas.clientWidth, sliderX));
					drawCanvas();
				},
				{ passive: false }
			);

			// Mobile-specific event handling
			document.addEventListener("click", (e) => {
				if (isMobile()) {
					const sidebar = document.getElementById("sidebar");
					// If the click is outside the sidebar (search + list), hide the list
					if (!sidebar.contains(e.target)) {
						vehicleList.classList.remove("visible");
					}
				}
			});
		</script>
	</body>
</html>
